<template>
  <div class="container">
    <div class="amap-wrapper">
      <el-amap :vid="'amap-vue'" :center="center" :zoom="zoom" :plugin="plugins">
        <el-amap-marker v-for="marker in markers" :key="marker.key" :position="marker.position" :events="marker.events" :visible="marker.visible" :draggable="marker.draggable" :title="marker.title"></el-amap-marker>
        <el-amap-info-window :position="info.position" :content="info.content" :visible="info.visible" :events="info.events"></el-amap-info-window>
        <el-amap-polyline :editable="polyline.editable"  :path="polyline.path" :events="polyline.events"></el-amap-polyline>
      </el-amap>
    </div>
    <mu-dialog :open="dialog" @close="closeDialog" :title="markerDetails.title">
      <p>卫星: {{markerDetails.data.satenum}} 颗 {{markerDetails.data.fixed ? "(已定位)" : "(定位中)"}}</p>
      <p>经度: {{markers[markerDetails.activeMarker].position[0].toFixed(8)}}</p>
      <p>纬度: {{markers[markerDetails.activeMarker].position[1].toFixed(8)}}</p>
      <p>光照: {{markerDetails.data.light}} lux</p>
      <p>温度: {{markerDetails.data.temperature}} ℃</p>
      <mu-flat-button primary label="关闭" @click="closeDialog" slot="actions"/>
    </mu-dialog>
    <mu-snackbar v-if="snackbar" message="已连接" action="好的" actionColor="greenA700" @actionClick="hideSnackbar" @close="hideSnackbar"/>
  </div>
</template>

<script>
export default {
  data () {
    return {
      ws: null,
      snackbar: false,
      dialog: false,
      zoom: 10,
      center: [121.5273285, 31.21515044],
      lng: 0,
      lat: 0,
      sensor: {},
      markerDetails: {
        activeMarker: 0,
        title: '实时数据',
        showCheckbox: false,
        data: {
          fixed: false,
          satenum: 0,
          lng: 'N/A',
          lat: 'N/A',
          light: 'N/A',
          temperature: 'N/A'
        }
      },
      plugins: [
        'MapType',
        'Scale'
      ],
      markers: [
        {
          key: 'mk-0',
          position: [121.5273285, 31.21515044],
          events: {
            click: () => {
              this.markerDetails.activeMarker = 0
              this.openDialog()
            },
            dragend: (e) => {
              this.markers[0].position = [e.lnglat.lng, e.lnglat.lat]
            }
          },
          visible: false,
          draggable: true,
          title: 'robot 0'
        },
        {
          key: 'mk-1',
          position: [121.6074416, 31.1912367],
          events: {
            click: () => {
              this.markerDetails.activeMarker = 1
              this.openDialog()
            },
            dragend: (e) => {
              this.markers[1].position = [e.lnglat.lng, e.lnglat.lat]
            }
          },
          visible: false,
          draggable: true,
          title: 'robot 1'
        },
        {
          key: 'mk-2',
          position: [121.225835, 31.065199],
          events: {
            click: () => {
              this.markerDetails.activeMarker = 2
              this.openDialog()
            }
          },
          visible: true,
          draggable: false,
          title: 'robot gps'
        }
      ],
      info: {
        position: [121.2347983, 31.0609022],
        content: '<p style="text-align: center;"><img src="http://o7spigzvd.bkt.clouddn.com/linkgo-logo-border-160x160.png" width="48" height="48"><br><span>邻感科技</span></p>',
        visible: true,
        events: {
          close () {
            console.log('close info window')
          }
        }
      },
      polyline: {
        path: [[121.2343911449, 31.0613320593], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.234377851, 31.0612903451], [121.2343694548, 31.06126363593], [121.2343694548, 31.06126363593], [121.2343694548, 31.06126363593], [121.2343694558, 31.06127534262], [121.2343694558, 31.06127534262], [121.2343694558, 31.06127534262], [121.2343694558, 31.06127534262], [121.2342962035, 31.0612103588], [121.2342779165, 31.06120707026], [121.2342779165, 31.06120707026], [121.2342462422, 31.06123711058], [121.2342529419, 31.06129213716], [121.2342779217, 31.06126870551], [121.2342779217, 31.06126870551], [121.2342779217, 31.06126870551], [121.2342779217, 31.06126870551], [121.2342679307, 31.06128872425], [121.2342679307, 31.06128872425], [121.2342679307, 31.06128872425], [121.2342679307, 31.06128872425], [121.2342245536, 31.06118539687], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342095639, 31.0611771031], [121.2342545365, 31.06124210738], [121.2342545365, 31.06124210738], [121.2342545365, 31.06124210738], [121.2342545365, 31.06124210738], [121.2342545365, 31.06124210738], [121.2342545365, 31.06124210738], [121.2342545365, 31.06124210738], [121.2342679206, 31.06116865559], [121.2342679206, 31.06116865559], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342979054, 31.06124707856], [121.2342945074, 31.06124207817], [121.2342945074, 31.06124207817], [121.2342945074, 31.06124207817], [121.2342945074, 31.06124207817], [121.2342445475, 31.06128543946], [121.2343178963, 31.06131210117], [121.2346576701, 31.06153028038], [121.2346360228, 31.0619722486], [121.2347892239, 31.06209050669], [121.2348658661, 31.06204712741], [121.2348658661, 31.06204712741], [121.2349058565, 31.06226722488], [121.2348975627, 31.06227223361], [121.2348975627, 31.06227223361], [121.2348059259, 31.06225558915], [121.23479763, 31.06223388265], [121.2340314343, 31.06164750315], [121.2338033001, 31.06160424785], [121.2341663434, 31.06174575999], [121.2339365224, 31.06185929451], [121.2337533625, 31.06190115493], [121.2336467441, 31.06191954544], [121.2333986216, 31.06179306082], [121.233265312, 31.06165308252], [121.2331587987, 31.06170819575], [121.2329755381, 31.06167331734], [121.2332569824, 31.06122614474], [121.2334218483, 31.06113266551], [121.2334351376, 31.06112595157], [121.2335250498, 31.06089405077], [121.2335050632, 31.06087405445], [121.2334218139, 31.06072403177], [121.2334984486, 31.06064062591], [121.2333818286, 31.0605356544], [121.2333701367, 31.06052565758], [121.2333035811, 31.06044736356], [121.233200266, 31.06051247995], [121.2331702998, 31.06063917546], [121.2331270302, 31.06060258782], [121.2331120421, 31.06060590126], [121.2331836841, 31.06057582893], [121.2333401497, 31.06040731272], [121.2334150858, 31.06032881073], [121.2334917255, 31.0603054392], [121.233443455, 31.06022042715], [121.2334767356, 31.06029044197], [121.2334634417, 31.0602421244], [121.2335033994, 31.06010031295], [121.2335833293, 31.05998688762], [121.2335666347, 31.05990185154], [121.2335366576, 31.05990347512], [121.2335099668, 31.05977342085], [121.2335799073, 31.05969502312], [121.2337331781, 31.05953151427], [121.2337197783, 31.05941475745], [121.2337597573, 31.05952148863], [121.2339396282, 31.05957968794], [121.2340795157, 31.05947122239], [121.2342210862, 31.05916594358], [121.2343876722, 31.05925087075], [121.2345108634, 31.05901394585], [121.2346574499, 31.05891208206], [121.2347606719, 31.0588569767], [121.2349438356, 31.05877179787], [121.2350787361, 31.05871006749], [121.2351970594, 31.05877332092], [121.2353085929, 31.05889661395], [121.2353685623, 31.05902164403], [121.2352970173, 31.05909173375], [121.2351671135, 31.05917026921], [121.2351571352, 31.05934537647], [121.235148747, 31.05941702336], [121.235150446, 31.05941872315], [121.2350138492, 31.05951557447], [121.2348973371, 31.05959069977], [121.2347690293, 31.05960910148], [121.2348107099, 31.05972914053], [121.2348839676, 31.05984085247], [121.2349139482, 31.05986084268], [121.2349139482, 31.05986084268], [121.2348557013, 31.06000426606], [121.2347557768, 31.06006267059], [121.2346958252, 31.06013115262], [121.2347740811, 31.06026777493], [121.2347375122, 31.06032953637], [121.2347375122, 31.06032953637], [121.2347924799, 31.06040784199], [121.2347391277, 31.06052634784], [121.2347325333, 31.06053795919], [121.2345742532, 31.06062152048], [121.2346176302, 31.06071654366], [121.2347541437, 31.06084311836], [121.2348025149, 31.06090812109], [121.2346909008, 31.06098824657], [121.2345759931, 31.06111009873], [121.234585989, 31.06114681254], [121.2345443221, 31.06118516448], [121.2346409611, 31.06128185029], [121.2346126839, 31.06131188777], [121.2344578065, 31.06144867767], [121.234367872, 31.0614537458], [121.2342929246, 31.06143218805], [121.2340631041, 31.06156573301], [121.2340297396, 31.06169583203], [121.2343229494, 31.06198578269], [121.2344728451, 31.06203570242], [121.2342762335, 31.06139377827]],
        events: {
        },
        editable: false
      }
    }
  },
  computed: {
    finished () {
    }
  },
  methods: {
    openDialog () {
      this.dialog = true
    },
    closeDialog () {
      this.dialog = false
    },
    showSnackbar () {
      this.snackbar = true
      if (this.snackTimer) {
        clearTimeout(this.snackTimer)
      }
      this.snackTimer = setTimeout(() => {
        this.snackbar = false
      }, 2000)
    },
    hideSnackbar () {
      this.snackbar = false
      if (this.snackTimer) clearTimeout(this.snackTimer)
    }
  },
  mounted () {
    this.ws = new WebSocket('ws://librae8226-pwa.goiot.cc/ws')
    console.log(this.ws)
    this.ws.onmessage = (ev) => {
      let j = JSON.parse(ev.data)
      console.log(j)
      if (j.type === 'sensor') {
        this.markerDetails.data.light = j.light
        this.markerDetails.data.temperature = j.temp
      } else if (j.type === 'gps') {
        this.markerDetails.data.satenum = j.satenum
        if (parseInt(j.isfix) === 1) {
          this.markerDetails.data.fixed = true
          this.markers[2].position = [parseFloat(j.gpsloc.longitude), parseFloat(j.gpsloc.latitude)]
        } else {
          this.markerDetails.data.fixed = false
        }
      } else {
      }
    }
    this.ws.onopen = (ev) => {
      this.showSnackbar()
    }
  },
  destroyed () {
    this.ws.send('destroyed')
    this.ws.close()
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
.container {
  position: absolute;
  width: 100%;
  top: 58px;
  bottom: 0px;
}
.amap-wrapper {
  width: 100%;
  height: 100%;
}
.step-button {
  margin-top: 12px;
  margin-right: 12px;
}
@media (max-width: 768px) {
  .container {
  top: 0px;
  bottom: 58px;
  }
}
</style>
